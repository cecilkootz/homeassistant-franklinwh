---
phase: 03-vendor-and-wire-http-client
plan: "02"
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - custom_components/franklin_wh/coordinator.py
  - custom_components/franklin_wh/config_flow.py
  - custom_components/franklin_wh/manifest.json
autonomous: true
requirements:
  - VEND-03
  - HAINT-01
  - HAINT-02
  - HAINT-03
  - HAINT-04

must_haves:
  truths:
    - "coordinator.py imports Client, TokenFetcher, Mode from .franklinwh (local vendored package)"
    - "coordinator.py passes get_async_client(hass) as session into TokenFetcher and Client constructors"
    - "config_flow.py imports from .franklinwh and passes get_async_client(hass) into TokenFetcher and Client"
    - "manifest.json requirements array does not contain franklinwh"
    - "No async_add_executor_job wrapping client construction in coordinator or config_flow — client init is now non-blocking"
  artifacts:
    - path: "custom_components/franklin_wh/coordinator.py"
      provides: "FranklinWHCoordinator with injected HA httpx client"
      contains: "get_async_client"
    - path: "custom_components/franklin_wh/config_flow.py"
      provides: "validate_input using injected HA httpx client"
      contains: "get_async_client"
    - path: "custom_components/franklin_wh/manifest.json"
      provides: "Integration manifest without franklinwh PyPI dependency"
  key_links:
    - from: "coordinator.py FranklinWHCoordinator.__init__"
      to: "TokenFetcher / Client constructors"
      via: "get_async_client(hass) stored as self._http_session, passed at construction"
      pattern: "get_async_client"
    - from: "config_flow.py validate_input"
      to: "TokenFetcher / Client constructors"
      via: "get_async_client(hass) passed at construction"
      pattern: "get_async_client"
---

<objective>
Wire the integration to use HA's managed httpx client throughout — updating coordinator.py, config_flow.py, and manifest.json so no blocking SSL calls occur on startup.

Purpose: With the vendored client now accepting an injected session, this plan connects it to HA's httpx client (homeassistant.helpers.httpx_client.get_async_client). Client construction is no longer blocking, so async_add_executor_job wrapping is no longer needed.

Output: Integration that uses HA's managed httpx client with franklinwh removed from manifest.json requirements.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-vendor-and-wire-http-client/03-01-SUMMARY.md
</context>

<interfaces>
<!-- Key contracts the executor needs. -->

From custom_components/franklin_wh/franklinwh/client.py (after Plan 01):
```python
class TokenFetcher(HttpClientFactory):
    def __init__(self, username: str, password: str, session: httpx.AsyncClient | None = None) -> None: ...

class Client(HttpClientFactory):
    def __init__(
        self, fetcher: TokenFetcher, gateway: str, url_base: str = DEFAULT_URL_BASE, session: httpx.AsyncClient | None = None
    ) -> None: ...
```

From homeassistant.helpers.httpx_client:
```python
def get_async_client(hass: HomeAssistant, verify_ssl: bool = True) -> httpx.AsyncClient:
    """Return the HA-managed httpx AsyncClient. Do not close it."""
```

The HA-managed client is long-lived — do NOT use it as an async context manager and do NOT close it.
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Update coordinator.py to import from .franklinwh and inject HA httpx client</name>
  <files>custom_components/franklin_wh/coordinator.py</files>
  <action>
    Make the following changes to coordinator.py:

    **Change 1 — Update imports:**
    Remove:
    ```python
    from franklinwh import Client, TokenFetcher, Mode
    from franklinwh.client import Stats
    ```
    Add:
    ```python
    from .franklinwh import Client, TokenFetcher, Mode
    from .franklinwh.client import Stats
    from homeassistant.helpers.httpx_client import get_async_client
    ```

    **Change 2 — Store HA httpx client in __init__:**
    In FranklinWHCoordinator.__init__, after the `super().__init__(...)` call, add:
    ```python
    self._http_session = get_async_client(hass)
    ```

    **Change 3 — Remove executor job wrapping for client construction:**
    The current code creates the client inside `async_add_executor_job`:
    ```python
    def create_client():
        token_fetcher = TokenFetcher(self.username, self.password)
        return Client(token_fetcher, self.gateway_id)

    self.client = await self.hass.async_add_executor_job(create_client)
    self.token_fetcher = self.client.fetcher
    ```
    Replace with a direct async construction (no executor needed — construction is now non-blocking):
    ```python
    self.token_fetcher = TokenFetcher(
        self.username, self.password, session=self._http_session
    )
    self.client = Client(
        self.token_fetcher, self.gateway_id, session=self._http_session
    )
    ```

    No other changes. All existing error handling, retry logic, and methods remain intact.
  </action>
  <verify>python3 -c "import ast, sys; ast.parse(open('custom_components/franklin_wh/coordinator.py').read()); print('syntax ok')"</verify>
  <done>coordinator.py parses without error; imports from .franklinwh; contains get_async_client; no async_add_executor_job wrapping client construction</done>
</task>

<task type="auto">
  <name>Task 2: Update config_flow.py and manifest.json</name>
  <files>
    custom_components/franklin_wh/config_flow.py
    custom_components/franklin_wh/manifest.json
  </files>
  <action>
    **config_flow.py changes:**

    Change 1 — Update imports at the top of the file:
    Remove:
    ```python
    import franklinwh
    ```
    Add:
    ```python
    from . import franklinwh as franklinwh_lib
    from homeassistant.helpers.httpx_client import get_async_client
    ```

    Change 2 — Update validate_input to use injected HA httpx client and remove executor wrapping:
    The current validate_input creates the client inside async_add_executor_job and calls get_stats in another executor job. Replace the entire try block body with:
    ```python
    http_session = get_async_client(hass)
    token_fetcher = franklinwh_lib.TokenFetcher(username, password, session=http_session)
    client = franklinwh_lib.Client(token_fetcher, gateway_id, session=http_session)

    # Validate by fetching stats (async, no executor needed)
    stats = await client.get_stats()

    if stats is None:
        raise CannotConnect("Unable to fetch data from FranklinWH")

    return {
        "title": f"FranklinWH {gateway_id[-6:]}",
        "gateway_id": gateway_id,
    }
    ```

    Note: The existing except blocks (CannotConnect, InvalidAuth, InvalidGateway) remain unchanged after the try body.

    **manifest.json changes:**

    Remove `"franklinwh>=1.0.0"` from the requirements array. Since it is the only entry, the result is:
    ```json
    "requirements": [],
    ```

    manifest.json keys must remain alphabetically sorted after domain/name (hassfest requirement — established in v1.0). Verify the existing key order is preserved.
  </action>
  <verify>python3 -c "import ast; ast.parse(open('custom_components/franklin_wh/config_flow.py').read()); print('syntax ok')" && python3 -c "import json; m=json.load(open('custom_components/franklin_wh/manifest.json')); print('requirements:', m['requirements'])"</verify>
  <done>config_flow.py parses without error; imports from .franklinwh; contains get_async_client; manifest.json requirements is an empty list</done>
</task>

</tasks>

<verification>
1. python3 -c "import ast; ast.parse(open('custom_components/franklin_wh/coordinator.py').read()); ast.parse(open('custom_components/franklin_wh/config_flow.py').read()); print('both ok')"
2. python3 -c "import json; m=json.load(open('custom_components/franklin_wh/manifest.json')); assert 'franklinwh' not in str(m.get('requirements', [])), 'franklinwh still in requirements'; print('manifest ok')"
3. grep -n "get_async_client" custom_components/franklin_wh/coordinator.py custom_components/franklin_wh/config_flow.py — appears in both files
4. grep -n "async_add_executor_job" custom_components/franklin_wh/coordinator.py — should not appear in client construction block
5. grep -n "from franklinwh\|import franklinwh" custom_components/franklin_wh/coordinator.py custom_components/franklin_wh/config_flow.py — no bare franklinwh imports (only .franklinwh)
</verification>

<success_criteria>
- coordinator.py and config_flow.py import from .franklinwh (local vendored package)
- Both files pass get_async_client(hass) as session into TokenFetcher and Client
- Client construction is direct (no async_add_executor_job wrapper)
- manifest.json requirements is [] (franklinwh removed)
- All Python files parse without syntax errors
</success_criteria>

<output>
After completion, create .planning/phases/03-vendor-and-wire-http-client/03-02-SUMMARY.md
</output>
