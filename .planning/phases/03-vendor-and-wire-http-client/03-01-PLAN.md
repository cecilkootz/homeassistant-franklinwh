---
phase: 03-vendor-and-wire-http-client
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - custom_components/franklin_wh/franklinwh/__init__.py
  - custom_components/franklin_wh/franklinwh/api.py
  - custom_components/franklin_wh/franklinwh/client.py
  - custom_components/franklin_wh/franklinwh/caching_thread.py
autonomous: true
requirements:
  - VEND-01
  - VEND-02

must_haves:
  truths:
    - "custom_components/franklin_wh/franklinwh/ exists with all four source files"
    - "Client.__init__ accepts an optional httpx.AsyncClient session parameter — no SSL context created if one is injected"
    - "TokenFetcher.fetch_token uses an injected session when provided, or creates one per-request otherwise"
    - "No SSL context is created at import time or at Client/TokenFetcher construction time when a session is injected"
  artifacts:
    - path: "custom_components/franklin_wh/franklinwh/__init__.py"
      provides: "Package re-exports: Client, TokenFetcher, Mode, Stats, etc."
    - path: "custom_components/franklin_wh/franklinwh/api.py"
      provides: "DEFAULT_URL_BASE constant"
    - path: "custom_components/franklin_wh/franklinwh/client.py"
      provides: "Client, TokenFetcher, Mode, Stats, and supporting types — with injected-session support"
    - path: "custom_components/franklin_wh/franklinwh/caching_thread.py"
      provides: "CachingThread (copied verbatim)"
  key_links:
    - from: "custom_components/franklin_wh/franklinwh/client.py Client.__init__"
      to: "httpx.AsyncClient session parameter"
      via: "optional session: httpx.AsyncClient | None = None; self.session = session if session is not None else self.get_client()"
      pattern: "def __init__.*session.*httpx"
    - from: "custom_components/franklin_wh/franklinwh/client.py TokenFetcher.fetch_token"
      to: "httpx.AsyncClient"
      via: "accepts optional session; uses async with (self._session or self.get_client()) as client"
      pattern: "fetch_token.*session"
---

<objective>
Vendor the franklinwh PyPI library into the integration and modify the client to accept an injected httpx.AsyncClient, eliminating synchronous SSL context creation.

Purpose: The upstream Client creates an httpx.AsyncClient at __init__ time (self.session = self.get_client()), which triggers synchronous SSL context creation — the source of the load_verify_locations blocking call warning. Vendoring lets us modify this without forking.

Output: custom_components/franklin_wh/franklinwh/ package with a modified client that accepts an injected session.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Copy upstream library files verbatim</name>
  <files>
    custom_components/franklin_wh/franklinwh/__init__.py
    custom_components/franklin_wh/franklinwh/api.py
    custom_components/franklin_wh/franklinwh/caching_thread.py
  </files>
  <action>
    Create custom_components/franklin_wh/franklinwh/ as a Python package containing verbatim copies of the upstream franklinwh library files. The installed package is at:
      /Users/matt/.pyenv/versions/franklinwh/lib/python3.12/site-packages/franklinwh/

    Files to copy verbatim (no changes):
    - api.py — contains only `DEFAULT_URL_BASE: Final[str] = "https://energy.franklinwh.com/"`
    - caching_thread.py — copy as-is (do not copy caching_thread_test.py)
    - __init__.py — copy as-is; it re-exports from .client and .api

    Do NOT copy __pycache__/ or caching_thread_test.py.

    Use the Read tool on each source file to get the exact content, then Write each to the destination path.
  </action>
  <verify>python3 -c "import sys; sys.path.insert(0, 'custom_components/franklin_wh'); from franklinwh import DEFAULT_URL_BASE; print(DEFAULT_URL_BASE)"</verify>
  <done>franklinwh/ subdirectory exists with __init__.py, api.py, caching_thread.py all present</done>
</task>

<task type="auto">
  <name>Task 2: Vendor and modify client.py to accept injected httpx.AsyncClient</name>
  <files>custom_components/franklin_wh/franklinwh/client.py</files>
  <action>
    Copy the upstream client.py from /Users/matt/.pyenv/versions/franklinwh/lib/python3.12/site-packages/franklinwh/client.py and make the following targeted modifications:

    **Modification 1 — TokenFetcher.__init__: accept optional session**
    Change the TokenFetcher.__init__ signature to:
    ```python
    def __init__(self, username: str, password: str, session: httpx.AsyncClient | None = None) -> None:
    ```
    Store it: `self._session = session`

    **Modification 2 — TokenFetcher.fetch_token: use injected session or create per-request**
    The current code is:
    ```python
    async with self.get_client() as client:
        res = await client.post(url, data=form, timeout=10)
    ```
    When an injected session is present, it is HA's managed client (do not use as async context manager, it is long-lived). When no session is injected, create one per-request via get_client() as before.

    Change to:
    ```python
    if self._session is not None:
        res = await self._session.post(url, data=form, timeout=10)
    else:
        async with self.get_client() as client:
            res = await client.post(url, data=form, timeout=10)
    ```

    **Modification 3 — Client.__init__: accept optional session**
    Change the Client.__init__ signature to:
    ```python
    def __init__(
        self, fetcher: TokenFetcher, gateway: str, url_base: str = DEFAULT_URL_BASE, session: httpx.AsyncClient | None = None
    ) -> None:
    ```
    Change the session assignment line from:
    ```python
    self.session = self.get_client()
    ```
    to:
    ```python
    self.session = session if session is not None else self.get_client()
    ```

    No other changes to client.py. All existing logic, methods, debug hooks, and UnknownMethodsClient remain intact.

    Note: When session is injected (HA's managed client), no SSL context is created at Client construction time. The SSL context is part of the httpx.AsyncClient that HA already created and manages. When session is None (fallback), behavior is identical to upstream.
  </action>
  <verify>python3 -c "import sys; sys.path.insert(0, 'custom_components/franklin_wh'); from franklinwh.client import Client, TokenFetcher; import inspect; sig = inspect.signature(Client.__init__); print('session param:', 'session' in sig.parameters); sig2 = inspect.signature(TokenFetcher.__init__); print('tf session param:', 'session' in sig2.parameters)"</verify>
  <done>Client.__init__ and TokenFetcher.__init__ both have a session parameter; python3 import succeeds with no SSL context creation at import time</done>
</task>

</tasks>

<verification>
1. python3 -c "import sys; sys.path.insert(0, 'custom_components/franklin_wh'); from franklinwh import Client, TokenFetcher, Mode, Stats" — no errors
2. ls custom_components/franklin_wh/franklinwh/ shows: __init__.py, api.py, client.py, caching_thread.py
3. grep -n "def __init__" custom_components/franklin_wh/franklinwh/client.py — shows session parameter in both Client and TokenFetcher
</verification>

<success_criteria>
- franklinwh/ package exists at custom_components/franklin_wh/franklinwh/
- Client and TokenFetcher accept an optional session: httpx.AsyncClient | None = None parameter
- No SSL context is created when session is injected at construction time
- All upstream types (Mode, Stats, SwitchState, GridStatus, etc.) remain importable
</success_criteria>

<output>
After completion, create .planning/phases/03-vendor-and-wire-http-client/03-01-SUMMARY.md
</output>
