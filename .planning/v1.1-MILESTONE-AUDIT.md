---
milestone: v1.1
audited: "2026-02-28T02:28:01Z"
status: tech_debt
scores:
  requirements: 7/7
  phases: 1/1
  integration: 7/7
  flows: 2/2
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 03-vendor-and-wire-http-client
    items:
      - "Missing VERIFICATION.md — verifier_enabled=false in config, phase not formally verified by automated verifier"
      - "Debug-mode session mutation: when Client is constructed with debug logging enabled and an injected session, event_hooks are appended to the shared HA-managed httpx.AsyncClient. Non-blocking under normal operation but could accumulate duplicates in edge cases (parallel Client construction)."
      - "BUG-01 deferred: config_flow.py wraps async client.get_stats() in async_add_executor_job (pre-existing, out of scope)"
      - "TEST-01 deferred: unit tests for vendored client session injection"
      - "TEST-02 deferred: integration tests for coordinator update cycle"
---

# Milestone v1.1 Audit — Fix Blocking HTTP Client

**Audited:** 2026-02-28
**Status:** tech_debt — all requirements satisfied, no critical blockers, process debt noted

## Summary

| Dimension | Score | Status |
|-----------|-------|--------|
| Requirements | 7/7 | ✓ |
| Phases | 1/1 | ✓ |
| Integration | 7/7 wired | ✓ |
| E2E Flows | 2/2 complete | ✓ |
| VERIFICATION.md | 0/1 present | ⚠ tech debt |

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | Description | REQUIREMENTS.md | SUMMARY Frontmatter | VERIFICATION.md | Final Status |
|--------|-------------|----------------|--------------------|-----------------||-------------|
| VEND-01 | Vendored library at custom_components/franklin_wh/franklinwh/ | `[x]` Complete | 03-01-SUMMARY | missing | partial → satisfied† |
| VEND-02 | Client/TokenFetcher accept injected httpx.AsyncClient | `[x]` Complete | 03-01-SUMMARY | missing | partial → satisfied† |
| VEND-03 | manifest.json has no franklinwh in requirements | `[x]` Complete | 03-02-SUMMARY | missing | partial → satisfied† |
| HAINT-01 | coordinator.py imports from .franklinwh | `[x]` Complete | 03-02-SUMMARY | missing | partial → satisfied† |
| HAINT-02 | coordinator.py passes get_async_client(hass) to TokenFetcher and Client | `[x]` Complete | 03-02-SUMMARY | missing | partial → satisfied† |
| HAINT-03 | config_flow.py imports from .franklinwh | `[x]` Complete | 03-02-SUMMARY | missing | partial → satisfied† |
| HAINT-04 | No load_verify_locations blocking call on startup | `[x]` Complete | 03-02-SUMMARY | missing | partial → satisfied† |

† VERIFICATION.md absent (verifier_enabled=false in config). All 7 requirements confirmed **satisfied** by independent integration checker code trace, SUMMARY.md frontmatter (2 summaries cover all 7 IDs), and REQUIREMENTS.md checkbox state.

**Orphaned requirements:** None — all 7 appear in SUMMARY.md frontmatter.

## Integration Checker Results

**Wiring:** 7/7 requirements wired — all exports properly consumed by coordinators/config_flow.

### E2E Flow 1: HA Loads Integration → No Blocking SSL Call

1. `FranklinWHCoordinator.__init__` → `get_async_client(hass)` at line 72 → stored as `self._http_session`. No SSL context created. ✓
2. First poll → `TokenFetcher(username, password, session=self._http_session)` → uses injected session. ✓
3. `Client(token_fetcher, gateway_id, session=self._http_session)` → `session is not None` branch taken, no `get_client()` call. ✓
4. `client.get_stats()` → async HTTP via HA-managed httpx.AsyncClient. ✓
5. `FranklinWHData` returned. ✓

### E2E Flow 2: Config Flow — User Sets Up Integration

1. `validate_input(hass, data)` → `get_async_client(hass)` → HA-managed client. ✓
2. `franklinwh_lib.TokenFetcher(username, password, session=http_session)` → vendored package via `from . import franklinwh as franklinwh_lib`. ✓
3. `franklinwh_lib.Client(token_fetcher, gateway_id, session=http_session)`. ✓
4. `client.get_stats()` awaited directly (no executor). ✓
5. Typed exceptions (`CannotConnect`, `InvalidAuth`, `InvalidGateway`) map to user-facing error keys. ✓

## Tech Debt

### Phase 03: vendor-and-wire-http-client

| Item | Severity | Notes |
|------|----------|-------|
| Missing VERIFICATION.md | Low | verifier_enabled=false in config; 2 of 3 cross-reference sources confirm all requirements satisfied |
| Debug-mode session mutation | Low | `event_hooks` appended to shared HA httpx client when `debug=True`; non-blocking under normal operation |
| BUG-01: config_flow executor wrapper | Low | Pre-existing bug, deferred — config_flow wraps async `client.get_stats()` in `async_add_executor_job` (incorrect usage) |
| TEST-01 | Low | Unit tests for vendored client session injection — deferred to future milestone |
| TEST-02 | Low | Integration tests for coordinator update cycle — deferred to future milestone |

## Phase Verification Status

| Phase | VERIFICATION.md | SUMMARY Coverage | Integration Check |
|-------|----------------|-----------------|-------------------|
| 03-vendor-and-wire-http-client | ⚠ Missing | ✓ 7/7 REQ-IDs | ✓ 7/7 wired |

*Note: verifier was intentionally disabled (verifier_enabled: false in .planning/config.json) during this milestone.*
